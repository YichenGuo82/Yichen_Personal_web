---
title: "ARMA/ARIMA MODEL"
format:
  html:
    code-fold: true
    theme: custom.scss
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
      df_print: paged
---

```{r,echo=FALSE,message=FALSE, warning=FALSE}
library(flipbookr)
library(tidyverse)
library(forecast)
library(astsa) 
library(xts)
library(tseries)
library(fpp2)
library(fma)
library(lubridate)
library(tidyverse)
library(TSstudio)
library(quantmod)
library(tidyquant)
library(plotly)
library(ggplot2)
```


## SPY Time Series Plot

```{r}
spy <- getSymbols("SPY",auto.assign = FALSE, from = "2017-10-01",src="yahoo") 
spy=data.frame(spy)
spy <- data.frame(spy,rownames(spy))

colnames(spy)[7] = "date"

spy$date<-as.Date(spy$date,"%Y-%m-%d")

plot_ly(spy, x = ~date, y = ~SPY.Adjusted, type = "scatter", mode = "lines") %>%
  layout(title = "SPY Adjusted Price Time Series", yaxis = list(title = "SPY Price"))

ts_adjusted <- as.ts(spy[,"SPY.Adjusted"], frequency = 1)
```

- Trend: There appears to be an overall upward trend in the price of SPY over the period from October 2017 to February 2023.
- Seasonality: There does not appear to be a clear seasonal pattern in the data.
- Variation: There is significant variation in the price of SPY over the period, with some periods of rapid growth and some periods of decline.
- Periodic fluctuations: There may be some periodic fluctuations in the data, but they are not clear from this plot. It is possible that a more detailed analysis of the data would reveal periodic fluctuations at different time scales.

In terms of whether the time series is multiplicative or additive, it's difficult to tell definitively from the plot alone. A common approach to determining whether a time series is multiplicative or additive is to decompose it into its components (trend, seasonality, etc.) 

### Lag plot
```{r}
ts_lags(ts_adjusted, lags=1:6)
```

The lag plot of SPY shown an steady upward trend, suggests the presence of positive autocorrelation in the SPY stock price and it's lagged price. It suggests that past values of the time series **can be used to predict** future values, and that simple models that assume the time series is constant over time may not be appropriate.

### Decompose of the SPY time series plot (Not Applicable)

```{r}
# Decompose the time series
try({decomp <- decompose(ts_adjusted)})
```

From the code we have learn that this dataset has **no periods**, it means that there is no clear and consistent repeating pattern in the data. Thus the traditional decompose() or stl() dosn't work on the dataset.

In general, stock prices are considered to be non-periodic because they do not exhibit a clear and consistent repeating pattern over time with a fixed period. The fluctuations in stock prices are influenced by a complex and ever-changing set of factors, such as company performance, economic indicators, geopolitical events, and investor sentiment, among others. These factors can cause stock prices to rise or fall in unpredictable ways that are difficult to forecast.

### ACF and PACF on the original time series
```{r}
require(gridExtra)

plot5 = ggAcf(ts_adjusted)+ggtitle("ACF of SPY Adjusted Close Price")
plot6 = ggPacf(ts_adjusted)+ggtitle("PACF of SPY Adjusted Close Price")
grid.arrange(plot5, plot6,nrow=2)
```

The ACF shows a slow decay in correlation, it suggests that the original series is **non-stationary** and that there may be a trend or seasonality present.  A spike at lag 1 in the PACF suggests that the correlation between the observations separated by k time steps is significant, and that the first lag may be a good candidate for an autoregressive (AR) term in a time series model.

In order to make the dataset stationary for the future analysis, there will be two potential ways, detrending and differencing. 

### Augmented Dickey-Fuller Test
```{r}
# Perform ADF test
adf_test <- adf.test(ts_adjusted)

# Print the results
print(adf_test)
```

Since the p-value is less than 0.05 (assuming a 95% confidence level), then we can reject the null hypothesis that the time series is non-stationary, and conclude that the time series is stationary, which is different from my finding in the ACF plot. It is possible that there is some other factor that is affecting the results. It is also possible that the sample size is too small or the data is too noisy to draw reliable conclusions.

## Detrending and Differencing
```{r,message=FALSE, warning=FALSE}


fit = lm(ts_adjusted~time(ts_adjusted), na.action=NULL) 
# regress stock price on time
# time creates the vector of times at which a time series was sampled.

plot1<-autoplot(resid(fit), main="Detrended") 
plot2<-autoplot(diff(ts_adjusted), main="First Differences") 

grid.arrange(plot1, plot2,nrow=2)
```

From the graph we can see that detrending (the residuals of the linear regression model fit to the time series) the time series doesn't remove the  patterns or trends in the residuals, indicating the linear model is not a good fit for the data. 

However, differencing (the change in value from one time period to the next) successfully make the distributed around zero, which means that there is no systematic increase or decrease in the values of the time series from one time period to the next. In other words, the difference between consecutive observations in the time series is centered around zero, indicating the first order differences of SPY is **stationary**.

### ACF and PACF plot on First Differences

```{r,message=FALSE, warning=FALSE}
plot3 <- ggAcf(diff(ts_adjusted))+ggtitle("ACF of First Differences of SPY Adjusted Close Price")
plot4 <- ggPacf(diff(ts_adjusted))+ggtitle("PACF of First Differences of SPY Adjusted Close Price")

grid.arrange(plot3, plot4,nrow=2)
```

Now the acf plot incidate the first difference of SPY adjusted close price is stationary and we could utilized it for further analysis such as the ARIMA modeling. 

## Linear regression on the fit the SPY dataset

```{r,message=FALSE, warning=FALSE}
library(knitr)
summary_table = summary(fit)$coefficients
# Extract the coefficient table from the summary

kable(summary_table, caption = "Regression Results", align = "c")
```

```{r, message=FALSE, warning= FALSE}
y=ts_adjusted
x=time(ts_adjusted)
DD<-data.frame(x,y)
ggp <- ggplot(DD, aes(x, y)) +           
  geom_line()

ggp +                                     
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth") +ggtitle("The adjusted SPY closed price")+ylab("Price(USD)")
```